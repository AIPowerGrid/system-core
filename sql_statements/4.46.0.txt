-- Add progress tracking columns to processing_gens table
ALTER TABLE processing_gens
ADD COLUMN IF NOT EXISTS progress_percent INTEGER NOT NULL DEFAULT 0,
ADD COLUMN IF NOT EXISTS current_step INTEGER NOT NULL DEFAULT 0,
ADD COLUMN IF NOT EXISTS total_steps INTEGER NOT NULL DEFAULT 0,
ADD COLUMN IF NOT EXISTS progress_updated_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS wallet_id VARCHAR(42);

-- Add index on wallet_id for efficient lookups
CREATE INDEX IF NOT EXISTS ix_processing_gens_wallet_id ON processing_gens(wallet_id);

-- Add wallet_id to waiting_prompts table for tracking requester's wallet
ALTER TABLE waiting_prompts
ADD COLUMN IF NOT EXISTS wallet_id VARCHAR(42);

CREATE INDEX IF NOT EXISTS ix_waiting_prompts_wallet_id ON waiting_prompts(wallet_id);

-- Add media_type to waiting_prompts for image vs video tracking
ALTER TABLE waiting_prompts
ADD COLUMN IF NOT EXISTS media_type VARCHAR(10) NOT NULL DEFAULT 'image';

CREATE INDEX IF NOT EXISTS ix_waiting_prompts_media_type ON waiting_prompts(media_type);

-- Add media_type to processing_gens for job-level tracking
ALTER TABLE processing_gens
ADD COLUMN IF NOT EXISTS media_type VARCHAR(10) NOT NULL DEFAULT 'image';

CREATE INDEX IF NOT EXISTS ix_processing_gens_media_type ON processing_gens(media_type);

-- Extend source_processing to support video modes (txt2video, img2video)
-- The column already exists, just widening the size
ALTER TABLE waiting_prompts
ALTER COLUMN source_processing TYPE VARCHAR(15);

-- Add file storage and metadata columns to processing_gens
ALTER TABLE processing_gens
ADD COLUMN IF NOT EXISTS tags JSONB,
ADD COLUMN IF NOT EXISTS r2_download_url TEXT,
ADD COLUMN IF NOT EXISTS file_size BIGINT;

-- Add index on file_size for efficient queries
CREATE INDEX IF NOT EXISTS ix_processing_gens_file_size ON processing_gens(file_size);

-- Add tags column to waiting_prompts for user-provided categorization
ALTER TABLE waiting_prompts
ADD COLUMN IF NOT EXISTS tags JSONB;

